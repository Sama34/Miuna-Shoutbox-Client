function escapeHtml(t){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,function(t){return e[t]})}function revescapeHtml(t){var e={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#039;":"'"};return t.replace(/(&amp;|&lt;|&gt;|&quot;|&#039;)/g,function(t){return e[t]})}function regexmiuna(t){format_search=[/\[url=(.*?)\](.*?)\[\/url\]/gi,/\[spoiler\](.*?)\[\/spoiler\]/gi,/(^|[^"=\]])(https?:\/\/[a-zA-Z0-9\.\-\_\-\/]+(?:\?[a-zA-Z0-9=\+\_\;\-\&]+)?(?:#[\w]+)?)/gim,/(^|[^"=\]\>\/])(www\.[\S]+(\b|$))/gim,/(^|[^"=\]])(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim],format_replace=['<a href="$1" target="_blank">$2</a>','<tag><div style="margin: 5px"><div style="font-size:11px; border-radius: 3px 3px 0 0 ; padding: 4px; background: #f5f5f5;border:1px solid #ccc;font-weight:bold;color:#000;text-shadow:none; ">'+spo_lan+":&nbsp;&nbsp;<input type=\"button\" onclick=\"if (this.parentNode.parentNode.getElementsByTagName('div')[1].getElementsByTagName('div')[0].style.display != '') { this.parentNode.parentNode.getElementsByTagName('div')[1].getElementsByTagName('div')[0].style.display = '';this.innerText = ''; this.value = '"+hide_lan+"'; } else { this.parentNode.parentNode.getElementsByTagName('div')[1].getElementsByTagName('div')[0].style.display = 'none'; this.innerText = ''; this.value = '"+show_lan+'\'; }" style="font-size: 9px;" value="'+show_lan+'"></div><div><div style="border:1px solid #ccc; border-radius: 0 0 3px 3px; border-top: none; padding: 4px;display: none;">$1</div></div></div></tag>','$1<a href="$2" target="_blank">$2</a>','$1<a href="http://$2" target="_blank">$2</a>','<a href="mailto:$1">$1</a>'];for(var e=0;e<format_search.length;e++)t=t.replace(format_search[e],format_replace[e]);for(var a in miuna_smilies)t=t.replace(new RegExp(""+a+"(?!\\S)","gi"),miuna_smilies[a]);return t}function imgconv(t){$("div."+t+", [data-idpos="+t+"]").find("a[href*='.jpg'], a[href*='.gif'], a[href*='.png']").each(function(t){var e=$(this).attr("href");$(this).children("img").length||$(this).empty().append('<img src="'+e+'" style="max-width:80px; max-height:80px" />')})}function scrollmiuna(t,e,a,s){($(""+e).scrollTop()+$(""+e).outerHeight()>$(""+e)[0].scrollHeight-90||"old"==a)&&(imgarea=t,"old"==a&&(imgarea=s),$(""+e).animate({scrollTop:$(""+e)[0].scrollHeight},10),$("div."+imgarea+" img, [data-idpos="+t+"] img").one("load",function(){$(""+e).animate({scrollTop:$(""+e)[0].scrollHeight},10)}).each(function(){this.complete&&$(this).load()}))}function autocleaner(t,e,a,s){$(""+t).children("div."+e).length>parseInt(a)-1&&(dif=$(""+t).children("div."+e).length-(parseInt(a)-1),"top"==s?$(""+t).children("div."+e).slice(-dif).remove():$(""+t).children("div."+e).slice(0,dif).remove()),setTimeout(function(){$(".shoutarea").children("[data-ment=yes]").length?document.title="("+$(".shoutarea").children("[data-ment=yes]").length+") "+orgtit:document.title=orgtit},200)}function shoutgenerator(t,e,a,s,o,n,r,i,l,c,u,m,d,p,g,h){var f=lanpm=pmspan=area=scrollarea=count=coloruser=usravatar=shoutcolor="";"top"==p?(f="prepend","logback"==t&&(f="append")):(f="append","logback"==t&&(f="prepend")),a==s?(lanpm=pm_fromlan,c=l):(lanpm=pm_tolan,c=c),"shout"==t?(area=scrollarea=".shoutarea",count="msgstcount",autocleaner(area,count,g,p)):"pm"==t?(area=scrollarea="[data-uidpm="+a+"]",count="pmmsgstcount",autocleaner(area,count,g,p)):(area=".loglist",scrollarea=".logstyle",count="msglog"),-1!=$.inArray(parseInt(o),msbvar.miunamodgroups.split(",").map(function(t){return Number(t)}))?coloruser=moduser_color:coloruser=commonuser_color,coloruser.trim()&&(stylecluser='style="color:'+coloruser+'"'),parseInt(actavat)&&(r.trim()?usravatar="<span class='msb_tvatar'><img src="+escapeHtml(r)+" /></span>":usravatar="<span class='msb_tvatar'><img src='"+imagepath+"/default_avatar.png' /></span>"),parseInt(actcolor)&&n&&/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(n)&&(shoutcolor='style="color:'+n+'"'),"shout"!=t&&"lognext"!=t&&"logback"!=t||"pmshout"!=m&&"pmsystem"!=m||(pmspan="<span class='pm_inf'>["+lanpm+" "+escapeHtml(c)+"] </span>"),("shout"==m||"pmshout"==m)&&$(""+area)[f]("<div class='msgShout "+count+" "+escapeHtml(e)+"' data-uid="+parseInt(s)+" data-ided="+escapeHtml(e)+">"+usravatar+"<span class='time_msgShout'><span>[</span>"+i+"<span>]</span></span>"+pmspan+"<span class='username_msgShout' "+stylecluser+">"+escapeHtml(l)+"</span>:<span class='content_msgShout' "+shoutcolor+">"+u+"</span></div>"),("system"==m||"pmsystem"==m)&&$(""+area)[f]("<div class='msgShout "+count+" "+escapeHtml(e)+"' data-uid="+parseInt(s)+" data-ided="+escapeHtml(e)+">"+usravatar+pmspan+"*<span class='username_msgShout' "+stylecluser+">"+escapeHtml(l)+"</span><span class='content_msgShout' "+shoutcolor+">"+u+"</span>*</div>"),0==h&&("lognext"==t||"logback"==t?(parseInt(actaimg)&&imgconvlog(),"top"!=p&&scrollmiunalog()):(parseInt(actaimg)&&imgconv(count),"top"!=p&&scrollmiuna(e,scrollarea,d,count)))}function miunashout(){function t(t){$(".actusr").text(""+usractlan+" "+Object.keys(t.usernames).length)}function e(t,e,a,s,o,r,i,l,c,u,m,d,p,g,h){var f=moment(p).utcOffset(parseInt(zoneset)).format(zoneformt);e=regexmiuna(escapeHtml(revescapeHtml(e))),nums=numshouts,("lognext"==t||"logback"==t)&&(nums=mpp),shoutgenerator(t,d,s,o,r,i,l,f,a,c,e,m,g,direction,nums,h),1==n[o]&&$("[data-uid="+o+"]").find(".time_msgShout span").css("color",on_color),"1"==u&&$("div."+d).css("background-color",edt_color)}function a(t,a,s,o,n,r,i,l,c,u,m,d,p,g,h){var f="shout";if(("lognext"==t||"logback"==t)&&(f=t),"0"==o)e(f,a,s,n,n,r,i,l,o,u,m,d,p,g,h);else if(n==msbvar.mybbuid){if(("msg"==t||"lognext"==t||"logback"==t)&&e(f,a,s,c,n,r,i,l,o,u,m,d,p,g,h),!$("[data-uidpm="+c+"]").length||"lognext"==t||"logback"==t)return;e("pm",a,s,c,n,r,i,l,o,u,m,d,p,g,h)}else{if(c!=msbvar.mybbuid)return;if(("msg"==t||"lognext"==t||"logback"==t)&&e(f,a,s,n,n,r,i,l,o,u,m,d,p,g,h),!$("[data-uidpm="+n+"]").length||"lognext"==t||"logback"==t)return;e("pm",a,s,n,n,r,i,l,o,u,m,d,p,g,h)}}function s(t,e){t=regexmiuna(escapeHtml(revescapeHtml(t))),setTimeout(function(){parseInt(actaimg)&&imgconv(count),$(".shoutarea").children().hasClass(e)&&"top"!=direction&&scrollmiuna(e,".shoutarea","new","msgstcount"),"undefined"!=typeof $("div."+e).parent(".pmarea").attr("data-uidpm")&&(area2="[data-uidpm="+$("div."+e).parent(".pmarea").attr("data-uidpm")+"]","top"!=direction&&scrollmiuna(e,area2,"new",'"pmmsgstcount";'))},50),$("div."+e).children(".content_msgShout").html(t),$("div."+e).css("background-color",edt_color)}var o="",n="",r=!1;socket.once("login",function(e){r=!0,t(e),o=e.usernames,n=e.uidlist,socket.emit("getoldmsg",{ns:numshouts,uid:msbvar.mybbuid})}),socket.on("user joined",function(e){t(e),o=e.usernames,n=e.uidlist,$("[data-uid="+e.uid+"]").length&&$("[data-uid="+e.uid+"]").find(".time_msgShout span").css("color",on_color)}),socket.on("user left",function(e){t(e),o=e.usernames,n=e.uidlist,$("[data-uid="+e.uid+"]").length&&$("[data-uid="+e.uid+"]").find(".time_msgShout span").css("color","")}),socket.emit("add user",{nick:msbvar.mybbusername,uidts:parseInt(msbvar.mybbuid)}),socket.emit("getnot",function(t){}),socket.once("getnot",function(t){t&&$(".notshow").text(escapeHtml(t.not))}),socket.on("updnot",function(t){$(".notshow").text(t?escapeHtml(t.not):"")}),socket.once("load old msgs",function(t){for(var e=t.length-1;e>=0;e--)a("msg",t[e].msg,t[e].nick,t[e].nickto,t[e].uid,t[e].gid,t[e].colorsht,t[e].avatar,t[e].uidto,t[e].edt,t[e].type,t[e]._id,t[e].created,"old",e)}),socket.on("message",function(t){a("msg",t.msg,t.nick,t.nickto,t.uid,t.gid,t.colorsht,t.avatar,t.uidto,t.edt,t.type,t._id,t.created,"new",0)}),socket.on("updmsg",function(t){t&&s(t.newmsg,t.id)}),socket.on("rmvmsg",function(t){t&&$("div.wrapShout").children("div."+t.id).remove()}),($.fn.on||$.fn.live).call($(document),"click",".shouttab",function(t){t.preventDefault(),$(".tabShout").removeClass("selected"),$(".shouttab").addClass("selected"),$(".wrapShout").hide(),$(".shoutarea").show(),"top"!=direction&&$(".shoutarea").animate({scrollTop:$(".shoutarea")[0].scrollHeight},10),$("#shout_text").attr("data-type","shout")}),($.fn.on||$.fn.live).call($(document),"click",".actusr",function(t){function e(t){$("#onnow").prepend('<span class="usron">'+escapeHtml(t)+", </span>")}t.preventDefault(),$(".tabShout").removeClass("selected"),$(".actusr").addClass("selected"),$(".numusr").html('<div id="onnow"></div>'),Object.keys(o).map(function(t){e(o[t])});var a=$(".usron:last").html();a&&$(".usron:last").html(a.slice(0,-2)),$(".wrapShout").hide(),$(".numusr").show()})}